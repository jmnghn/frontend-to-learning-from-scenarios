## 멀티 웹뷰 그리고 딥링크 구현

요즘에는 iOS, 안드로이드 가리지 않고 사용하는 용어. 딥링크.

```
1. 유니버셜 링크
2. 딥링크(앱스킴)
3. 딥링크 설계
```

### [유니버셜 링크](https://developer.apple.com/ios/universal-links/)

애플이 제안한 스펙. iOS에서 제안되는 스펙이다.

```
# Communicate with Other Apps
https://myphotoapp.example.com/albums?albumname=vacation&index=1
https://myphotoapp.example.com/albums?albumname=wedding&index=17
```

"웹페이지 URL을 그대로 앱에 진입하는 용도로도 사용하겠다."는 것이 범용링크. 즉, Universal Links라고 할 수 있다. <br />
모든 서비스는 앱으로도 제공하고 웹으로도 제공이 되니, 이 두 가지가 공유되고 사용자들한테 교환될 때 동일한 링크를 가지고 동일한 포맷을 가지고 공유되면 좋을것이다. 이와 같은 맥락에서 만들어진 스펙이라고 볼 수 있다.<br />
하지만, 단점도 있다. 왜냐하면 요즘 대부분의 풀 웹 서비스를 제공하는 경우가 별로 없다 보니까 이걸 구현하려고 하면 굉장히 셋팅도 까다롭고, 웹 페이지의 화면과 앱의 화면이 어느 정도 일치되어 있어야 구현하는 게 큰 무리가 없다고 하는 측면이 있다. "신경 써야 될 것들이 굉장히 많다.😭" 그리고 사실 유니버셜 링크는 많이 쓰이진 않는다. 잘 안쓴다.<br />
대신 딥링크라고 하는 것을 거의 표준처럼 사용한다.

<br />

### [딥링크](https://reactnavigation.org/docs/deep-linking/)

```json
{
  "expo": {
    // (...)
    "scheme": "shop12app" // scheme은 prefix를 뭘로 쓸지 지정하는 속성. shop12app://home
    // (...)
  }
}
```

"이 링크를 만나면 이 앱이 설치가 될 때 위 scheme가 시스템에 등록이 되고, 이것과 일치되는 링크가 클릭이 됐을 땐 OS가 해당하는 연결된 앱으로 보내준다"는 매커니즘이라고 보면 된다. 안드로이드와 iOS 모두 사용할 수 있는 메커니즘이다.

```html
// jsx
<a href="shop12app://home">12SHOP</a>
<a href="exp://127.0.0.1:19000/--/home">Back to home screen</a> // local :)
```

웹뷰 내의 모든 화면의 전환을 딥링크 스펙으로 만들어서 전환을 한다고 하면, 실제로 라우팅이 네이티브 앱에서 하는 것과 똑같은 효과를 얻을 수 있다. 그리고 URL도 웹의 URL과 똑같이 뒤쪽의 쿼리 파라미터 등등을 다 지원하기 때문에 소량의 데이터를 서로 주고받는 스펙으로도 충분히 쓸 수 있다.<br />
이와 같은 측면에서 딥링크를 굉장히 많이 활용한다.

<br />

### 딥링크 설계

그러면 이 딥링크 스펙은 누가 만들까?<br />
당연히 앱 개발쪽에서 딥링크 스펙을 만들게 될 것이다.<br />
그러면 프론트엔드 개발자는 "스펙이 나오면 그 스펙에 맞춰서 개발하면 되겠내?"라고 생각할 수도 있는데, 프론트엔드 개발자도 할 일이 있다. :)<br />

"딥링크라고 하는 스펙은, 미래를 어느정도 염두에 두고 스펙이 만들어져야 한다."는 맥락의 요청이다.<br />

화면 전환을 위한 단순한 라우팅 용도의 딥링크뿐만 아니라, 어떠한 프로세스를 담고 있는. 즉, <br />
프로세스 플로우에 대한 정보를 담고 있는 딥링크 스펙이 나올수도 있고,<br />
화면을 디스플레이 할 때 어떻게 디스플레이 할 건지에 대한 옵션들이 추가적으로 들어가야 되는 경우도 있다.<br />

이 두가지에 대한 예로,<br />
쇼케이스 화면이 있고, 이를 딥링크로 구현하려고 한다. <br />
그런데 만약 네비게이션과 관련해서 상단의 쇼케이스 네비게이션의 타이틀 바가 있는 상황에서 <br />
타이틀바를 네이티브 영역에서 가져가고 싶은 경우에는 어떻게 해야할까?

(현재상태 ↓)<br />
<img width="400" src="https://user-images.githubusercontent.com/19165916/195105019-9c268bc2-fa6a-4fd0-8d3f-0d784bcd0dcd.png">
<br />

일단, false로 되어있던 headerShown을 true로 변경한다. (타이틀을 네이티브 상단에 표시)<br />
그러면 상단에 타이틀바가 생길 것이다.

(headerShown: true ↓)<br />
<img width="400" src="https://user-images.githubusercontent.com/19165916/195105026-895a5853-2298-4fe7-a1be-810189e3379e.png">

```js
<Tab.Screen
  name="Showcase"
  component={Showcase}
  options={{
    headerShown: true, // ✅
    tabBarIcon: ({ focused }) =>
      focused ? (
        <Image source={ShowcaseIconOn} width={iconSize} height={iconSize} />
      ) : (
        <Image source={ShowcaseIconOff} width={iconSize} height={iconSize} />
      ),
  }}
/>
```

그리고 웹뷰에서의 타이틀을 없앤다.

```js
return (
    <>
      <PageView>
        {/* <Header title="쇼케이스" /> */}
```

(Header를 없앰 ↓)<br />

<img width="400" src="https://user-images.githubusercontent.com/19165916/195105040-82407243-b0dd-4b12-ad78-2ed8889d98ae.png">

위와 같은 상황들은 언제든지 생길 수 있다.<br />

예와 마찬가지로 일반적인 고정 지면 같은 경우에는 이런 변경이 아주 초기에 등장하지만, 만약에 고정 지면이 아니라 이벤트 웹뷰 같은 경우, 프로모션 같은 경우. <br />
어떤 프로모션은 타이틀 네비게이션 없이 풀 웹뷰로 띄워서 프로모션을 하고, 어떤 프로모션은 타이틀이 있는... 즉, 네이티브에서 타이틀을 가져와서 프로모션 지면은 그냥 그 하위에 표시 하고 싶은 경우라면 어떻게 될까? 당연히 똑같은 프로모션 링크가 있을 텐데, 그 프로모션 링크 안에 그런 류의 옵션들이 들어가야 할 것이다. "이 프로모션은 타이틀 바를 네이티브로 쓸 거에요. 혹은 안 쓸거에요." 하는 옵션들... 이런 다양한 옵션들을 얼마 든지 추가해 넣을 수 있는데, 딥링크의 스펙이 애초에 처음 만들어질 때 옵션같은 것들을 넣을 수 없는 구조로 만들어져 있다라고 하면, 네이티브 앱의 딥링크 스펙이 파편화가 될 수 있다. 초기에는 A라는 스펙으로 만들었다가 서비스를 계속 업그레이드 하다 보니까 B라는 스펙으로 바꿔야 하는 상황에 닥친다.<br />

B라는 스펙으로 변경하고, 딥링크는 말그대로 링크인데 앱 내에 있는 웹페이지 안에만 존재하는 링크가 아니라 외부로 나가있는 링크이기도 하다. 그러면 이를 바꾸는 순간 작동하지 않는 딥링크가 생기기도 하고, 굉장히 많은 문제들이 생긴다. 말하자면 dead 링크와 같은 상황들이 생긴다는 것이다. 그래서 이런 류의 서비스 바깥쪽으로 나가는 스펙에 대해서는 굉장히 신중해야 되고 꽤 근 미래에 대한 확장성까지 고려하여 그런 것들을 설계를 해야 한다는 것이다. <br /> 

이와 같은 부분들을 누가 이야기 해야 하냐를 보면 보통 앱 개발자들은 그것과 관련돼서는 크게 충분히 고민하지 않는다. 왜냐하면 '공유를 통한 서비스 진입 같은 경우는 웹을 이용하는 경우들이 굉장히 많다 보니까' 프론트엔드 개발자가 그런 제안들을 먼저 해주고, 고민들을 먼저 던져 주어서 스펙이 좀 더 확장적으로 만들어 질 수 있게끔 제안을 해야 되는 경우들이 많이 있다.(⭐️)<br />

이와 같은 부분들이 충분히 고려되지 않아서 딥링크 스펙이 앱 내에서 3~4개씩 되는 경우들도 굉장히 많다. 그러면 이제 어떤 딥링크는 버전 몇에서 작동하는데, 그 이상 부터는 작동은 안하고 이게 또 꼬여 가지고 어떤 걸 만들 땐 이 딥링크 써야 되는지 저 딥링크 써야 하는지... 하는 문제들이 발생한다.<br />
프론트엔드 개발자 입장에서 결국 그게 가장 고민이 되어버리는 것이다. 그런 류의 코드들이 내 코드에 있으면 사실 보기가 싫다. 그런 케이스 바이 케이스 코드를 친다는 게 쉬운 일이 아니고 또 기분이 그렇게 썩 좋지 않기 때문에 애초부터 잘 설계된 딥링크 스펙이었다면 훨씬 좋겠다는 이야기를 하는 것이다.<br />

그리고 두 번째로 플로우와 관련된 것들. 즉 멀티 웹뷰와 관련된 부분인데, 대표적인 케이스가 현재 예제에는 구현이 되어 있지 않지만, 회원가입 같은 경우가 그렇다. 회원가입을 한다거나 혹은 주문이나 결제 같은 것들을 하게 될 때 이 서비스에서 제공되는 것 말고 외부의 서비스를 이용해야 하는 경우들이 있다. 예를 들면 본인 인증을 하는 경우들이 대표적인 케이스다. 회원가입을 하는 중에 본인인증을 해야할 때 본인 인증 서비스를 어느 회사거를 쓴다 그러면 그 회사가 제공하는 모바일 웹 페이지를 풀 웹뷰로 띄워놓고 그리고 나서 거기가 종료가 됐을 때, 그 웹뷰가 닫혀야 되는 그런 케이스들...<br />

똑같은 웹뷰가 있을 때, 어떤 거는 그 웹뷰 안에서 동작의 수행이 끝나면 그 웹뷰만 닫히거나 혹은 어떤 곳은 그 웹뷰가 뜨고 동작이 끝나면 그 하위에 있는 웹뷰까지 모두 다 닫히는. 즉, 플로우가 있는. 예를 들면 '주문' 동선 같은 경우가 그럴 것이다. 주문 결제하기를 하고, 클릭을 하고 결제하기를 하고 그 다음 화면으로 넘어갔는데 그게 외부 웹뷰다. 그런데 기획적으로 거기서 주문취소라는 버튼을 눌렀을 때, 전체가 취소되게 하고 싶은 경우라면 그 밑에 있는 주문하고 있는 웹뷰도 여전히 있을텐데 같이 날아가야 하는 상황에 대한 것과 같은 이런 류의 옵션들을 담아야하는 경우, 딥링크에 충분히 담을 수 있다는 이야기다.<br />

현재는 없지만 더 많은 옵션들을 담을 수 있는 스펙과 사용자 동선(웹뷰가 지금 현재 있는 웹뷰가 끝나면 웹뷰 자체를 닫아주세요~ 아니면 어떻게 해주세요~ 라고 하는 플로우와 관련된 옵션들)까지도 커버할 수 있는 스펙으로 만들기를 프론트엔드 개발자가 제안을 해야한다.<br />

제일 흔한 스펙으로는 JSON을 사용하는 것이다.

```js
<a href="shop12app://home?options={ close: false }">12SHOP</a>
```

위와 같이 하면, `shop12app://home?options=`까지는 우리가 규격으로 만들어놓고, `{ close: false }`는 얼마든지 바꿀 수 있다. 앱에서 처리되는 스펙들이 변경이 되면 되고, 그리고 호환성도 유지하기가 훨씬 편하다. 데이터기 때문이다. 데이터는 언제든지 바뀔 수 있고, 바뀐 것에 대해서 유지보수하는 게 충분히 용이하다. 물론 여기서의 `shop12app://home?options=`의 스펙은 조금 다른 이야기다. 즉, 앱으로 진입시키느냐 마느냐와 같은 문제들이 걸려있기 때문이다.

그래도 결론은 `shop12app://home?options={ close: false }`식의 구조가 나오는게 가장 추천되는 구조다. :) <br />

이 이야기들은 딥링크 빙산의 일각...😭
